#!/bin/bash

BRANCH="$(git rev-parse --abbrev-ref HEAD)"
ROOT="$(git rev-parse --show-toplevel)"
CWD="$(pwd)"

cd "$ROOT"

[ "$(git status --porcelain)" ] && DIRTY=1 || DIRTY=
[ "$DIRTY" ] && git stash save -a
if [ "$BRANCH" != $SRC_BRANCH ]
then
    git checkout $SRC_BRANCH
fi
./configure

TARGET="$1"
KEEP=
PULL=
SAVE=
STATE=
for arg in "${@:2}"
do
    case "$arg" in
    -k)
        STATE=KEEP
        ;;
    -p)
        STATE=PULL
        ;;
    -s)
        STATE=SAVE
        ;;
    -r)
        STATE=README
        ;;
    -R)
        STATE=README_TEXT
        ;;
    *)
        case "$STATE" in
        KEEP)
            KEEP="$KEEP '$arg'"
            ;;
        PULL)
            PULL="$PULL '$arg'"
            ;;
        SAVE)
            SAVE="$SAVE '$arg'"
            ;;
        README)
            cp "$arg" README.md
            KEEP="$KEEP README.md"
            STATE=
            ;;
        README_TEXT)
            echo "$arg" >README.md
            KEEP="$KEEP README.md"
            STATE=
            ;;
        *)
            continue
            ;;
        esac
        ;;
    esac
done

make "$TARGET"
git stash save -a -u

if [ -n "$(git rev-parse -q --verify $DEST_BRANCH)" ]
then
    git checkout $DEST_BRANCH
else
    git checkout --orphan $DEST_BRANCH
fi
git clean -dfx
git reset --hard
SRCS="$(git ls-tree -r --name-only stash Sources | sed '/\.gyb$/d')"
echo "$KEEP" | xargs git checkout -p stash --
echo "$SRCS" | xargs git checkout -p stash --

git stash drop
echo "$PULL" | xargs git checkout -p $SRC_BRANCH --

echo "$KEEP" | xargs git add
echo "$SRCS" | xargs git add
echo "$PULL" | xargs git add

_generate

git commit -am "auto-generated commit using $(git rev-parse $SRC_BRANCH)" -m "generated by '$SELF_NAME'"

if [ -n "$SAVE" ]
then
    echo "$SAVE" | xargs git add
    git stash save
fi
git checkout $BRANCH
git clean -dfx
git reset --hard
git checkout -- .
if [ -n "$SAVE" ]
then
    git stash pop
    echo "$SAVE" | xargs git reset --
fi
[ "$DIRTY" ] && git stash pop

cd "$CWD"
